<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OrbitGuard</title>
  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.12);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --muted2: rgba(255,255,255,0.50);

      --good: #35d07f;
      --warn: #ffb020;
      --bad:  #ff5a67;

      --btn: rgba(255,255,255,0.10);
      --btnHover: rgba(255,255,255,0.14);
      --primary: #7c5cff;
      --primaryHover: #6b4ff6;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,92,255,0.30), transparent 55%),
        radial-gradient(900px 500px at 85% 15%, rgba(53,208,127,0.18), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(255,176,32,0.10), transparent 60%),
        var(--bg);
      min-height: 100vh;
    }

    .container{
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    header{
      display:flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 18px;
      margin-bottom: 18px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
    }

    .logo{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(124,92,255,1), rgba(53,208,127,0.9));
      box-shadow: 0 12px 30px rgba(124,92,255,0.25);
      position: relative;
      overflow: hidden;
    }
    .logo:after{
      content:"";
      position:absolute;
      width: 16px; height: 16px;
      border-radius: 50%;
      background: rgba(255,255,255,0.90);
      top: 9px; left: 11px;
      filter: blur(0.2px);
      opacity: 0.95;
    }

    h1{
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.2px;
      line-height: 1.15;
    }

    .subtitle{
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
    }

    .topRight{
      text-align: right;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .topRight code{
      font-family: var(--mono);
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 2px 8px;
      border-radius: 999px;
      color: rgba(255,255,255,0.88);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 900px){
      .grid{ grid-template-columns: 1.1fr 0.9fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      backdrop-filter: blur(8px);
    }

    .cardTitleRow{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .card h2{
      margin: 0;
      font-size: 15px;
      letter-spacing: 0.2px;
    }

    .hint{
      color: var(--muted);
      font-size: 12.5px;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
      margin-top: 12px;
    }

    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 220px;
      flex: 1;
    }

    label{
      font-size: 12px;
      color: var(--muted);
    }

    input{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      outline: none;
    }
    input::placeholder{ color: rgba(255,255,255,0.45); }
    input:focus{
      border-color: rgba(124,92,255,0.55);
      box-shadow: 0 0 0 4px rgba(124,92,255,0.18);
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
      align-items:center;
    }

    button{
      border: 1px solid rgba(255,255,255,0.14);
      background: var(--btn);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: 120ms ease;
      font-weight: 600;
      font-size: 13px;
    }
    button:hover{ background: var(--btnHover); }
    button:disabled{
      opacity: 0.55;
      cursor:not-allowed;
    }

    .primary{
      border-color: rgba(124,92,255,0.55);
      background: rgba(124,92,255,0.22);
    }
    .primary:hover{ background: rgba(124,92,255,0.28); }
    .ghost{
      background: transparent;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      white-space: nowrap;
    }
    .dot{
      width: 8px; height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.65);
    }
    .pill.good .dot{ background: var(--good); }
    .pill.warn .dot{ background: var(--warn); }
    .pill.bad  .dot{ background: var(--bad); }

    .mono{
      font-family: var(--mono);
      font-size: 12px;
    }

    .split{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }

    .split strong{ font-size: 13px; }
    .split .muted{ color: var(--muted); font-size: 12px; }

    .panel{
      margin-top: 12px;
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px;
    }

    .panelTitle{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 8px;
    }

    .panelTitle h3{
      margin: 0;
      font-size: 13px;
      color: rgba(255,255,255,0.88);
    }

    pre{
      margin: 0;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,0.82);
      overflow:auto;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.4;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
    }

    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      text-align:left;
      font-size: 13px;
      vertical-align: top;
    }
    th{
      color: rgba(255,255,255,0.78);
      font-size: 12px;
      letter-spacing: 0.2px;
      background: rgba(255,255,255,0.04);
    }
    tr:hover td{ background: rgba(255,255,255,0.03); }

    .right{
      text-align:right;
    }

    .toast{
      position: fixed;
      left: 18px;
      bottom: 18px;
      max-width: 520px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(8px);
      color: rgba(255,255,255,0.92);
      box-shadow: 0 18px 50px rgba(0,0,0,0.35);
      display:none;
      gap: 10px;
      align-items:flex-start;
    }
    .toast.show{ display:flex; }
    .toast .dot{ margin-top: 5px; }
    .toast .msg{ font-size: 13px; color: rgba(255,255,255,0.90); }
    .toast .sub{ font-size: 12px; color: var(--muted); margin-top: 2px; }

    dialog{
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      background: rgba(15,18,35,0.96);
      color: var(--text);
      width: min(840px, calc(100vw - 28px));
      padding: 0;
      overflow:hidden;
    }
    dialog::backdrop{
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(6px);
    }
    .modalHeader{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
    }
    .modalHeader h3{
      margin: 0;
      font-size: 14px;
      color: rgba(255,255,255,0.92);
    }
    .modalBody{ padding: 14px; }
    .modalClose{
      background: transparent;
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
    }

    /* Space theme */
    :root{
      --bg2: #070913;
      --glow: rgba(124,92,255,0.35);
      --glow2: rgba(53,208,127,0.25);
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events:none;
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(124,92,255,0.12), transparent 55%),
        radial-gradient(800px 450px at 85% 15%, rgba(53,208,127,0.09), transparent 55%),
        radial-gradient(900px 700px at 50% 100%, rgba(255,176,32,0.06), transparent 60%),
        radial-gradient(1200px 900px at 50% 50%, rgba(255,255,255,0.05), transparent 65%),
        linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.35));
      mix-blend-mode: screen;
    }

    /*Star Canvas*/
    #stars{
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
      opacity: 0.75;
    }

    .container{ position: relative; z-index: 1; }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.13);
      box-shadow:
        0 18px 60px rgba(0,0,0,0.35),
        0 0 0 1px rgba(124,92,255,0.08) inset;
    }

    .card:hover{
      border-color: rgba(124,92,255,0.28);
      box-shadow:
        0 22px 70px rgba(0,0,0,0.45),
        0 0 0 1px rgba(124,92,255,0.12) inset,
        0 0 40px rgba(124,92,255,0.08);
      transform: translateY(-1px);
      transition: 160ms ease;
    }

    .logo{
      background: radial-gradient(circle at 35% 30%, rgba(255,255,255,0.75), rgba(255,255,255,0.12) 30%, transparent 55%),
                  linear-gradient(135deg, rgba(124,92,255,1), rgba(53,208,127,0.85));
      box-shadow:
        0 12px 35px rgba(124,92,255,0.28),
        0 0 30px rgba(53,208,127,0.12);
    }
    .logo:before{
      content:"";
      position:absolute;
      inset: -10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.16);
      opacity: 0.55;
      transform: rotate(18deg);
    }
    .logo:after{
      filter: blur(0.2px);
      box-shadow: 0 0 10px rgba(255,255,255,0.35);
    }

    button{
      box-shadow: 0 10px 28px rgba(0,0,0,0.25);
    }
    .primary{
      background: linear-gradient(180deg, rgba(124,92,255,0.35), rgba(124,92,255,0.18));
      border-color: rgba(124,92,255,0.55);
    }
    .primary:hover{
      background: linear-gradient(180deg, rgba(124,92,255,0.45), rgba(124,92,255,0.22));
      box-shadow: 0 0 0 4px rgba(124,92,255,0.10), 0 18px 40px rgba(0,0,0,0.32);
    }

    input:focus{
      border-color: rgba(124,92,255,0.65);
      box-shadow: 0 0 0 4px rgba(124,92,255,0.22), 0 0 22px rgba(124,92,255,0.12);
    }

    table{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.20), rgba(0,0,0,0.14));
    }
    th{
      background:
        linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    }

    @media (prefers-reduced-motion: reduce){
      .card:hover{ transform:none; }
    }

  </style>
</head>

<body>
  <canvas id="stars" aria-hidden="true"></canvas>
  <div class="container">
    <header>
      <div>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>OrbitGuard</h1>
            <div class="subtitle">Scan a time window against NASA/JPL CAD close-approach events. Store results as explainable risks.</div>
          </div>
        </div>
      </div>
      <div class="topRight">
        Backend: <code id="apiBase"></code><br/>
        <span id="apiStatus" class="pill"><span class="dot"></span><span>Checking API…</span></span>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Create + Job -->
      <section class="card">
        <div class="cardTitleRow">
          <h2>Run a scan</h2>
          <span class="hint">Create a job → run worker → view risks</span>
        </div>

        <div class="row">
          <div class="field">
            <label for="startIso">Start (ISO 8601)</label>
            <input id="startIso" placeholder="2025-12-25T00:00:00Z" />
          </div>
          <div class="field">
            <label for="endIso">End (ISO 8601)</label>
            <input id="endIso" placeholder="2026-02-23T00:00:00Z" />
          </div>
          <div class="field" style="max-width:260px;">
            <label for="thresholdKm">Threshold (km)</label>
            <input id="thresholdKm" type="number" value="1000000" min="1" step="1000" />
          </div>
          <div class="field" style="max-width:220px;">
            <label for="windowDays">Window length (days)</label>
            <input id="windowDays" type="number" value="60" min="1" max="365" step="1" oninput="updateEndFromDays()" />
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="btnCreate" onclick="createScan()">Create scan job</button>
          <span class="hint">Worker: <span class="mono">python -m orbitguard.worker.run</span></span>
        </div>

        <div class="split" style="margin-top: 14px;">
          <div>
            <strong>Current job</strong>
            <div class="muted" id="currentJob">none yet</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="btnRefresh" onclick="refreshJob()">Refresh status</button>
            <button id="btnSummary" onclick="loadSummary()">Summary</button>
          </div>
        </div>

        <div class="panel">
          <div class="panelTitle">
            <h3>Job payload</h3>
            <span class="hint">Stored values returned by API</span>
          </div>
          <pre id="jobJson">{}</pre>
        </div>
      </section>

      <!-- Right: Results -->
      <section class="card">
        <div class="cardTitleRow">
          <h2>Results</h2>
          <span class="hint">Filtered by job_id</span>
        </div>

        <div class="actions" style="margin-top: 0;">
          <button class="primary" id="btnRisks" onclick="loadRisks()">Load risks</button>
          <button class="ghost" id="btnExplainHow" onclick="showHowTo()">How do I run the worker?</button>
        </div>

        <div class="panel" style="margin-top: 12px;">
          <div class="panelTitle">
            <h3>Scan summary</h3>
            <span class="hint">Counts for this job</span>
          </div>
          <pre id="summaryJson">No summary loaded yet.</pre>
        </div>

        <div class="panel" style="margin-top: 12px;">
          <div class="panelTitle">
            <h3>Risk events</h3>
            <span class="hint" id="riskCountHint">—</span>
          </div>
          <div id="risksWrap" class="hint">No risks loaded yet.</div>
        </div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <span class="dot" id="toastDot"></span>
    <div>
      <div class="msg" id="toastMsg"></div>
      <div class="sub" id="toastSub"></div>
    </div>
  </div>

  <dialog id="modal">
    <div class="modalHeader">
      <h3 id="modalTitle">Details</h3>
      <button class="modalClose" onclick="closeModal()">Close</button>
    </div>
    <div class="modalBody">
      <pre id="modalBody">{}</pre>
    </div>
  </dialog>

<script>
  function clampDays(n) {
    if (!Number.isFinite(n)) return 60;
    return Math.min(365, Math.max(1, Math.floor(n)));
  }

  function setStartNowIfEmpty() {
    const startEl = document.getElementById("startIso");
    const s = startEl.value.trim();
    if (!s) startEl.value = new Date().toISOString();
  }

    //Starfield canvas
  function initStars() {
    const canvas = document.getElementById("stars");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");

    const DPR = Math.min(2, window.devicePixelRatio || 1);
    let w = 0, h = 0;
    let stars = [];

    function resize() {
      w = canvas.clientWidth;
      h = canvas.clientHeight;
      canvas.width = Math.floor(w * DPR);
      canvas.height = Math.floor(h * DPR);
      ctx.setTransform(DPR, 0, 0, DPR, 0, 0);

      const count = Math.min(320, Math.floor((w * h) / 6500));
      stars = Array.from({ length: count }, () => ({
        x: Math.random() * w,
        y: Math.random() * h,
        r: Math.random() * 1.2 + 0.2,
        a: Math.random() * 0.7 + 0.15,        // alpha
        tw: Math.random() * 0.018 + 0.004,    // twinkle speed
        sp: Math.random() * 0.12 + 0.03       // drift speed
      }));
    }

    function draw(t) {
      ctx.clearRect(0, 0, w, h);

      //"milky way" gradient
      const grad = ctx.createLinearGradient(0, h * 0.2, w, h * 0.8);
      grad.addColorStop(0, "rgba(124,92,255,0.05)");
      grad.addColorStop(0.5, "rgba(255,255,255,0.03)");
      grad.addColorStop(1, "rgba(53,208,127,0.04)");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);

      for (const s of stars) {
        // drift
        s.y += s.sp;
        if (s.y > h + 2) s.y = -2;

        // twinkle
        const tw = 0.55 + 0.45 * Math.sin(t * s.tw + s.x * 0.02);
        const alpha = Math.max(0.08, Math.min(0.95, s.a * tw));

        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${alpha})`;
        ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        ctx.fill();
      }

      requestAnimationFrame(draw);
    }

    const ro = new ResizeObserver(resize);
    ro.observe(canvas);

    resize();
    requestAnimationFrame(draw);
  }

  function updateEndFromDays() {
    setStartNowIfEmpty();

    const startEl = document.getElementById("startIso");
    const endEl = document.getElementById("endIso");
    const daysEl = document.getElementById("windowDays");

    let days = clampDays(Number(daysEl.value));
    daysEl.value = days; // snap it to 1–365

    // Use start as the reference point
    let start = new Date(startEl.value);
    if (isNaN(start.getTime())) {
      // If user typed an invalid start, reset to now
      start = new Date();
      startEl.value = start.toISOString();
    }

    const end = new Date(start.getTime() + days * 24 * 3600 * 1000);
    endEl.value = end.toISOString();
  }

  const API_BASE = "http://127.0.0.1:8000";
  document.getElementById("apiBase").textContent = API_BASE;

  let currentJobId = null;
  let toastTimer = null;

  function setApiStatus(ok) {
    const el = document.getElementById("apiStatus");
    const label = el.querySelector("span:last-child");
    el.classList.remove("good", "bad", "warn");

    if (ok === true) {
      el.classList.add("good");
      label.textContent = "API online";
    } else if (ok === false) {
      el.classList.add("bad");
      label.textContent = "API offline";
    } else {
      el.classList.add("warn");
      label.textContent = "Checking API…";
    }
  }

  async function pingApi() {
    try {
      const res = await fetch(API_BASE + "/health");
      setApiStatus(res.ok);
    } catch {
      setApiStatus(false);
    }
  }

  function isoNowPlusDays(days) {
    const now = new Date();
    const end = new Date(now.getTime() + days * 24 * 3600 * 1000);
    return { start: now.toISOString(), end: end.toISOString() };
  }

  function unixToIso(ts) {
    return new Date(ts * 1000).toISOString();
  }

  async function api(path, opts = {}) {
    const res = await fetch(API_BASE + path, {
      headers: { "Content-Type": "application/json" },
      ...opts,
    });
    const text = await res.text();
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${text}`);
    return text ? JSON.parse(text) : null;
  }

  function setCurrentJob(id) {
    currentJobId = id;
    const el = document.getElementById("currentJob");
    el.textContent = id ? `Job #${id}` : "none yet";
  }

  function setBtnLoading(id, loading, labelWhenLoading = "Working…") {
    const btn = document.getElementById(id);
    if (!btn) return;
    btn.disabled = loading;
    btn.dataset._label = btn.dataset._label || btn.textContent;
    btn.textContent = loading ? labelWhenLoading : btn.dataset._label;
  }

  function toast(msg, sub = "", kind = "warn") {
    const el = document.getElementById("toast");
    const dot = document.getElementById("toastDot");
    const m = document.getElementById("toastMsg");
    const s = document.getElementById("toastSub");

    el.classList.remove("show");
    dot.style.background =
      kind === "good" ? "var(--good)" : kind === "bad" ? "var(--bad)" : "var(--warn)";
    m.textContent = msg;
    s.textContent = sub;

    clearTimeout(toastTimer);
    el.classList.add("show");
    toastTimer = setTimeout(() => el.classList.remove("show"), 3200);
  }

  function openModal(title, bodyObj) {
    document.getElementById("modalTitle").textContent = title;
    document.getElementById("modalBody").textContent =
      typeof bodyObj === "string" ? bodyObj : JSON.stringify(bodyObj, null, 2);
    document.getElementById("modal").showModal();
  }

  function closeModal() {
    document.getElementById("modal").close();
  }

  function showHowTo() {
    openModal(
      "Run the worker",
      "OrbitGuard uses a background worker to process scan jobs.\n\n" +
        "In a terminal:\n\n" +
        "  source .venv/bin/activate\n" +
        "  python -m orbitguard.worker.run\n\n" +
        "Then come back here and click “Refresh status” → “Load risks”."
    );
  }

  async function createScan() {
    const start_ts = document.getElementById("startIso").value.trim();
    const end_ts = document.getElementById("endIso").value.trim();
    const threshold_km = Number(document.getElementById("thresholdKm").value);

    if (!start_ts || !end_ts || !threshold_km) {
      toast("Missing fields", "Please enter start, end, and threshold.", "bad");
      return;
    }

    try {
      setBtnLoading("btnCreate", true, "Creating…");

      const payload = { start_ts, end_ts, threshold_km };
      const job = await api("/scans", { method: "POST", body: JSON.stringify(payload) });

      setCurrentJob(job.id);
      document.getElementById("jobJson").textContent = JSON.stringify(job, null, 2);

      document.getElementById("summaryJson").textContent = "No summary loaded yet.";
      document.getElementById("risksWrap").textContent = "No risks loaded yet.";
      document.getElementById("riskCountHint").textContent = "—";

      toast("Scan job created", `Job #${job.id} is ${job.status}. Run the worker to process it.`, "good");
    } catch (e) {
      toast("Failed to create scan", e.message, "bad");
    } finally {
      setBtnLoading("btnCreate", false);
    }
  }

  function jobPill(job) {
    const st = (job.status || "").toUpperCase();
    if (st === "SUCCEEDED") return ["good", "Succeeded"];
    if (st === "FAILED") return ["bad", "Failed"];
    if (st === "RUNNING") return ["warn", "Running"];
    return ["warn", st || "Unknown"];
  }

  async function refreshJob() {
    if (!currentJobId) {
      toast("No job selected", "Create a scan job first.", "bad");
      return;
    }

    try {
      setBtnLoading("btnRefresh", true, "Refreshing…");
      const job = await api(`/scans/${currentJobId}`);
      document.getElementById("jobJson").textContent = JSON.stringify(job, null, 2);

      const [kind, label] = jobPill(job);
      toast("Job status updated", `Job #${job.id}: ${label}`, kind);
    } catch (e) {
      toast("Failed to refresh job", e.message, "bad");
    } finally {
      setBtnLoading("btnRefresh", false);
    }
  }

  async function loadSummary() {
    if (!currentJobId) {
      toast("No job selected", "Create a scan job first.", "bad");
      return;
    }

    try {
      setBtnLoading("btnSummary", true, "Loading…");
      const summary = await api(`/scans/${currentJobId}/summary`);
      document.getElementById("summaryJson").textContent = JSON.stringify(summary, null, 2);

      toast(
        "Summary loaded",
        `${summary.events_in_window} events scanned • ${summary.risks_found} risks found`,
        "good"
      );
    } catch (e) {
      toast("Failed to load summary", e.message, "bad");
    } finally {
      setBtnLoading("btnSummary", false);
    }
  }

  async function loadRisks() {
    if (!currentJobId) {
      toast("No job selected", "Create a scan job first.", "bad");
      return;
    }

    try {
      setBtnLoading("btnRisks", true, "Loading…");
      const risks = await api(`/risks?job_id=${currentJobId}`);
      renderRisks(risks);
      toast("Risks loaded", `${risks.length} risk event(s) for job #${currentJobId}`, "good");
    } catch (e) {
      toast("Failed to load risks", e.message, "bad");
    } finally {
      setBtnLoading("btnRisks", false);
    }
  }

  function renderRisks(risks) {
    const wrap = document.getElementById("risksWrap");
    const hint = document.getElementById("riskCountHint");

    if (!risks || risks.length === 0) {
      hint.textContent = "0";
      wrap.textContent = "No risks for this job (try a larger threshold if you expected hits).";
      return;
    }

    hint.textContent = `${risks.length}`;

    const rows = risks
      .map((r) => {
        const dist = Math.round(r.min_distance_km).toLocaleString();
        const iso = unixToIso(r.tca_ts);
        const score = typeof r.risk_score === "number" ? r.risk_score.toFixed(6) : r.risk_score;

        return `
          <tr>
            <td class="right">${r.id}</td>
            <td>${escapeHtml(r.object_id)}</td>
            <td class="right">${dist}</td>
            <td><span class="mono">${iso}</span></td>
            <td class="right">${score}</td>
            <td class="right">
              <button class="ghost" onclick="explainRisk(${r.id})">Explain</button>
            </td>
          </tr>
        `;
      })
      .join("");

    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th class="right">ID</th>
            <th>Object</th>
            <th class="right">Miss dist (km)</th>
            <th>TCA (UTC)</th>
            <th class="right">Score</th>
            <th class="right">Details</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  async function explainRisk(riskId) {
    try {
      const expl = await api(`/risks/${riskId}/explain`);
      openModal(`Risk #${riskId} • ${expl.object_id}`, expl);
    } catch (e) {
      toast("Failed to load explanation", e.message, "bad");
    }
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
  initStars();
  updateEndFromDays(); // uses windowDays + startIso
  setApiStatus(null);
  pingApi();
</script>
</body>
</html>
